name: Data Pipeline

# Manual trigger only
on:
  workflow_dispatch:
    inputs:
      region:
        description: 'Region to process (used for backup/rollback)'
        required: true
        type: choice
        options:
          - sf_city
          - sf_bay
          - sf_bay_test
          - nyc
          - london
      sports:
        description: 'Sports to fetch (comma-separated, leave empty for all)'
        required: false
        type: string
        default: ''

jobs:
  data-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          cd data_enrichment
          pip install -r requirements.txt
      
      - name: Run database migrations
        run: |
          cd backend
          npm install
          # Add SSL parameters to DATABASE_URL for cloud databases
          DATABASE_URL_WITH_SSL="${{ secrets.PRODUCTION_DATABASE_URL }}?sslmode=require"
          DATABASE_URL="$DATABASE_URL_WITH_SSL" npm run migrate
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
      
      - name: Create database backup
        run: |
          # Create backup before processing
          # Use manual trigger inputs
          ENVIRONMENT="production"
          REGION="${{ github.event.inputs.region }}"
          cd data_enrichment
          # Set SSL environment variable for psycopg2
          export PGSSLMODE=require
          python scripts/create_backup.py \
            --environment $ENVIRONMENT \
            --region $REGION
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          PGSSLMODE: require
      
      - name: Run data pipeline
        run: |
          cd data_enrichment
          SPORTS="${{ github.event.inputs.sports }}"
          # Set SSL environment variable for psycopg2
          export PGSSLMODE=require
          
          echo "üèÄ Running data enrichment pipeline"
          echo "  Sports filter: ${SPORTS:-'(all sports: basketball, tennis, soccer, volleyball, pickleball)'}"
          
          # Run pipeline - uses DATABASE_URL env var for connection
          # Pass sports as second arg if specified (first arg is connection string)
          if [ -n "$SPORTS" ]; then
            python run_full_pipeline.py "$DATABASE_URL" "$SPORTS"
          else
            python run_full_pipeline.py "$DATABASE_URL"
          fi
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          PGSSLMODE: require
      
      - name: Validate data quality
        id: validate-data-quality
        run: |
          # Use manual trigger inputs
          ENVIRONMENT="production"
          REGION="${{ github.event.inputs.region }}"
          cd data_enrichment
          # Set SSL environment variable for psycopg2
          export PGSSLMODE=require
          python scripts/validate_data_quality.py \
            --environment $ENVIRONMENT \
            --region $REGION
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          PGSSLMODE: require
        continue-on-error: true
      
      - name: Auto-rollback on quality failure
        if: failure() && steps.validate-data-quality.outcome == 'failure'
        run: |
          # Use manual trigger inputs
          ENVIRONMENT="production"
          REGION="${{ github.event.inputs.region }}"
          cd data_enrichment
          # Set SSL environment variable for psycopg2
          export PGSSLMODE=require
          echo "üîÑ Data quality validation failed - initiating automatic rollback"
          python scripts/rollback.py \
            --environment $ENVIRONMENT \
            --region $REGION
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          PGSSLMODE: require
      
      - name: Notify success
        if: success()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const region = '${{ github.event.inputs.region }}';
            const environment = 'production';
            
            console.log(`‚úÖ Data pipeline completed successfully!`);
            console.log(`   Region: ${region}`);
            console.log(`   Environment: ${environment}`);
            
            // You can add more sophisticated success notifications here
      
      - name: Rollback on failure
        if: failure()
        run: |
          # Use manual trigger inputs
          ENVIRONMENT="production"
          REGION="${{ github.event.inputs.region }}"
          cd data_enrichment
          # Set SSL environment variable for psycopg2
          export PGSSLMODE=require
          python scripts/rollback.py \
            --environment $ENVIRONMENT \
            --region $REGION
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          PGSSLMODE: require
      
      - name: Notify failure
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const region = '${{ github.event.inputs.region }}';
            const environment = 'production';
            
            console.log(`‚ùå Data pipeline failed!`);
            console.log(`   Region: ${region}`);
            console.log(`   Environment: ${environment}`);
            console.log(`   Check the logs above for details.`);
            
            // You can add more sophisticated failure notifications here